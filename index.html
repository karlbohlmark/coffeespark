<!DOCTYPE html>
<html>
<head>
    
    <script>
            
    
        Object.keys = Object.keys || function(obj){
            var arr = [];
            for(var prop in obj){
                if(obj.hasOwnProperty(prop)){
                    arr.push(prop)
                }
            }
            return arr;
        }
    
        var observable = (function(){ 
            function isArray(o){
                return typeof o.push==="function"  && typeof o.length==="number"
            }
            
            function fieldname(propname){
                return '__' + propname;
            }
            
            function accessor(propname){
                return function(){
                    if(arguments.length===0)
                        return this[fieldname(propname)];
                    
                    if(arguments.length===1){
                        var oldval = this[fieldname(propname)];
                        var newval = arguments[0];
                        this[fieldname(propname)] = newval;
                        if(this.propertyChanged){
                            this.propertyChanged(propname, newval, oldval);
                        }
                    }
                }
            }
            
            
            function arrayAccessor(propname){
                return function(){
                    if(arguments.length===0)
                            return this[fieldname(propname)];
                    if(arguments.length===2){
                        var arr = this[fieldname(propname)];
                        var oldval =arr[arguments[0]];
                        var newval = arguments[1];
                        if(this.propertyChanged){
                            this.propertyChanged(propname, newval, oldval);
                        }
                    }
                }
            }
            
            return function(obj){
                var newObj = {};
                for(var prop in obj){
                    if(obj.hasOwnProperty(prop)){
                        var val = obj[prop];
                        if(typeof val==="string" || typeof val==="number"){
                            newObj['__'  + prop] = val;
                            newObj[prop] = accessor(prop)       
                        }else if(isArray(val)){
                            newObj['__'  + prop] = val;
                            newObj[prop] = arrayAccessor(prop)
                        }
                    }            
                }
                return newObj;
            }
        })()
        

            

        window.onload = (function() {
            var template = document.getElementById('template').innerHTML;
            var parser = new Parser(template, 0)
            var dom = parser.readTemplate();
            
            var products = []
            for(var i =0;i<7;i++){
                products.push('product ' + i)
            }
            
            var prods = observable({products:products})
            
            var test= {something: 2, testa: [1,3]};
            var otest = observable(test)
            
            document.getElementsByTagName('body')[0].innerHTML = new Compiler(dom).renderTemplate(prods)
        })
    </script>
    <script src="test.js"></script>
    
    <script id="template" type="text/spark">
        <ul>
            <li each="product in products">${product}</li>
        </ul>
    </script>
</head>
<body>
</body>
</html>
